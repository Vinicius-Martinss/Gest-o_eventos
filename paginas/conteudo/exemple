<?php
// Verifica se a sessão já foi iniciada
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

include('../config/conexao.php');

// Recupera o email da sessão
$email = isset($_SESSION['email']) ? $_SESSION['email'] : '';
$query = "SELECT email_user, senha_user, data_nascimento, foto_user FROM tb_user WHERE id_user=:id";
$stmt = $conect->prepare($query);
$stmt->bindParam(':id', $id_user, PDO::PARAM_STR);
$stmt->execute();
$row = $stmt->fetch(PDO::FETCH_ASSOC);
if ($row) {
    $email_antigo = $row['email_user'];
    $senha_antiga = $row['senha_user'];
    $data_nascimento   = isset($row['data_nascimento']) ? $row['data_nascimento'] : 'Não definido'; // Verifica se idade_user está definida
    $foto_user = $row['foto_user'];
}
function calcularIdade($data_nascimento) {
    $data_nascimento = new DateTime($data_nascimento);
    $hoje = new DateTime();
    $idade = $hoje->diff($data_nascimento)->y;
    return $idade;
}

?>

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Cadastro de Participantes</h1>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <!-- left column -->
                <div class="col-md-4">
                    <!-- general form elements -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Cadastre-se para Participar</h3>
                        </div>
                        <!-- /.card-header -->
                        <!-- form start -->
                        <form role="form" action="" method="post" enctype="multipart/form-data">
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="nome">Nome</label>
                                    <input type="text" class="form-control" name="nome" id="nome" required placeholder="Digite seu nome">
                                </div>
                                
                                <div class="form-group">
                                    <label for="sexo">Sexo</label>
                                    <select class="form-control" name="sexo" id="sexo" required>
                                        <option value="" disabled selected>Selecione seu sexo</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Feminino</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="eventos_registrados">Selecione um Evento</label>
                                    <select class="form-control" id="eventos_registrados" name="eventos_registrados" required>
                                        <option value="">Selecione um Evento</option>
                                        <?php
                                        // Consulta SQL para obter todos os eventos
                                        $queryEventos = "SELECT EventoID, nome_eventos, idade_minima FROM Eventos ORDER BY nome_eventos ASC";
                                        
                                        try {
                                            // Prepara e executa a consulta
                                            $resultEventos = $conect->prepare($queryEventos);
                                            $resultEventos->execute();
                                            
                                            // Verifica se há eventos registrados
                                            $contarEventos = $resultEventos->rowCount();
                                            if ($contarEventos > 0) {
                                                // Loop para exibir cada evento como uma opção no <select>
                                                while ($evento = $resultEventos->FETCH(PDO::FETCH_OBJ)) {
                                                    echo '<option value="' . $evento->EventoID . '" data-idade-minima="' . $evento->idade_minima . '">' . $evento->nome_eventos . '</option>';
                                                }
                                            } else {
                                                echo '<option value="">Nenhum evento encontrado</option>';
                                            }
                                        } catch (PDOException $e) {
                                            echo '<option value="">Erro ao buscar eventos</option>';
                                        }
                                        ?>
                                    </select>
                                </div>

                                <!-- Campo de Idade Mínima -->
                                <div class="form-group">
                                    <label for="idade_minima">Idade Mínima</label>
                                    <input type="text" class="form-control" id="idade_minima" name="idade_minima" readonly>
                                </div>

                                <div class="form-group">
                                    <input type="hidden" name="email" value="<?php echo htmlspecialchars($email); ?>">
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="exampleCheck1" required>
                                    <label class="form-check-label" for="exampleCheck1">Autorizo participar do Evento</label>
                                </div>
                            </div>
                            <!-- /.card-body -->

                            <div class="card-footer">
                                <button type="submit" name="botao" class="btn btn-primary">Participar do Evento</button>
                            </div>
                        </form>
                        
                        <?php
                        if (isset($_POST['botao'])) {
                            // Recupera os valores do formulário
                            $nome = $_POST['nome'];
                            $sexo = $_POST['sexo'];
                            $email = $_POST['email'];
                            $EventoID = $_POST['eventos_registrados'];

                            // Calcular a idade do usuário
                            $idade_usuario = calcularIdade($data_nascimento);

                            // Obter a idade mínima do evento selecionado
                            $queryIdadeMinima = "SELECT idade_minima FROM Eventos WHERE EventoID = :EventoID";
                            try {
                                $resultIdadeMinima = $conect->prepare($queryIdadeMinima);
                                $resultIdadeMinima->bindParam(':EventoID', $EventoID, PDO::PARAM_INT);
                                $resultIdadeMinima->execute();
                                
                                $evento = $resultIdadeMinima->fetch(PDO::FETCH_OBJ);
                                $idade_minima = $evento ? $evento->idade_minima : 0;
                            } catch (PDOException $e) {
                                echo "<strong>ERRO AO OBTER IDADE MÍNIMA: </strong>" . htmlspecialchars($e->getMessage());
                                exit;
                            }

                            // Verifica se a idade do usuário é suficiente para participar do evento
                            if ($idade_usuario < $idade_minima) {
                                echo '<div class="container">
                                        <div class="alert alert-danger alert-dismissible">
                                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                            <h5><i class="icon fas fa-times"></i> Erro!</h5>
                                            Você não possui a idade mínima de ' . $idade_minima . ' anos para participar deste evento.
                                        </div>
                                    </div>';
                            } else {
                                // Prepara a consulta SQL para inserir os dados no banco de dados
                                $cadastro = "INSERT INTO Participantes (nome, idade, sexo, email, EventoID) VALUES (:nome, :idade, :sexo, :email, :EventoID)";

                                try {
                                    // Prepara a consulta SQL com os parâmetros
                                    $result = $conect->prepare($cadastro);
                                    $result->bindParam(':nome', $nome, PDO::PARAM_STR);
                                    $result->bindParam(':idade', $idade_usuario, PDO::PARAM_INT);
                                    $result->bindParam(':sexo', $sexo, PDO::PARAM_STR);
                                    $result->bindParam(':email', $email, PDO::PARAM_STR);
                                    $result->bindParam(':EventoID', $EventoID, PDO::PARAM_INT);

                                    // Executa a consulta SQL
                                    $result->execute();

                                    // Verifica se a inserção foi bem-sucedida
                                    $contar = $result->rowCount();
                                    if ($contar > 0) {
                                        // Se a inserção for bem-sucedida, exibe mensagem de sucesso
                                        echo '<div class="container">
                                                <div class="alert alert-success alert-dismissible">
                                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                                <h5><i class="icon fas fa-check"></i> OK!</h5>
                                                Dados inseridos com sucesso !!!
                                            </div>
                                            </div>';
                                        header("Refresh: 5; URL=home.php");
                                    } else {
                                        // Se a inserção falhar, exibe mensagem de erro
                                        echo '<div class="container">
                                            <div class="alert alert-danger alert-dismissible">
                                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                            <h5><i class="icon fas fa-times"></i> Erro!</h5>
                                            Dados não inseridos !!!
                                            </div>
                                        </div>';
                                        header("Refresh: 5; URL=home.php");
                                    }
                                } catch (PDOException $e) {
                                    // Exibe mensagem de erro se ocorrer um erro de PDO
                                    echo "<strong>ERRO DE PDO= </strong>" . $e->getMessage();   
                                }
                            }
                        }
                        ?>
                    </div>
                </div>  
                
                <!-- Seção para Listagem de Eventos que o Usuário Está Participando -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Eventos Participando</h3>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Nome do Evento</th>
                                        <th>Data</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
                                    // Exibe os eventos que o usuário está participando
                                    $queryParticipantes = "SELECT E.nome_eventos, E.data_evento, P.ParticipanteID
                                                           FROM Participantes P
                                                           INNER JOIN Eventos E ON P.EventoID = E.EventoID
                                                           WHERE P.email = :email";

                                    try {
                                        $resultParticipantes = $conect->prepare($queryParticipantes);
                                        $resultParticipantes->bindParam(':email', $email, PDO::PARAM_STR);
                                        $resultParticipantes->execute();

                                        $contarParticipantes = $resultParticipantes->rowCount();
                                        if ($contarParticipantes > 0) {
                                            while ($participante = $resultParticipantes->FETCH(PDO::FETCH_OBJ)) {
                                                echo '<tr>
                                                        <td>' . htmlspecialchars($participante->nome_eventos) . '</td>
                                                        <td>' . htmlspecialchars($participante->data_evento) . '</td>
                                                        <td>
                                                            <form action="" method="post">
                                                                <input type="hidden" name="ParticipanteID" value="' . $participante->ParticipanteID . '">
                                                                <button type="submit" name="remover" class="btn btn-danger">Remover</button>
                                                            </form>
                                                        </td>
                                                    </tr>';
                                            }
                                        } else {
                                            echo '<tr><td colspan="3">Nenhum evento encontrado.</td></tr>';
                                        }
                                    } catch (PDOException $e) {
                                        echo '<tr><td colspan="3">Erro ao buscar eventos.</td></tr>';
                                    }
                                    ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
document.getElementById('eventos_registrados').addEventListener('change', function () {
    var selectedOption = this.options[this.selectedIndex];
    var idadeMinima = selectedOption.getAttribute('data-idade-minima');
    document.getElementById('idade_minima').value = idadeMinima ? idadeMinima : '';
});
</script>
